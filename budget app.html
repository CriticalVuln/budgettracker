<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personal Budget & Goals Tracker â€” Synced + Timeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Time adapter for Chart.js time scale -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .page { display: none; }
    .page.active { display: block; }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.25); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }

    .chart-container { position: relative; height: 40vh; width: 100%; }
    /* Layer two canvases for the Goal Progress card */
    .stacked-chart { position: relative; height: 42vh; width: 100%; }
    .stacked-chart canvas { position: absolute; inset: 0; width: 100% !important; height: 100% !important; }
    #goal-chart-lines { z-index: 0; pointer-events: none; }
    #goal-chart-bars { z-index: 1; background: transparent; }

    /* Glass cards */
    .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .soft-shadow { box-shadow: 0 10px 30px rgba(2, 6, 23, 0.12); }
    .card-title { letter-spacing: 0.2px; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 via-blue-50 to-indigo-100 text-slate-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
    <!-- Header & Navigation -->
    <header class="glass soft-shadow rounded-2xl p-5 mb-8">
      <div class="flex flex-col sm:flex-row justify-between items-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 via-indigo-700 to-blue-600">Personal Finance Dashboard</h1>
        <nav class="mt-4 sm:mt-0 flex gap-2">
          <button id="nav-budget" class="nav-btn px-4 py-2 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow hover:brightness-110 transition">Budget</button>
          <button id="nav-goals" class="nav-btn px-4 py-2 rounded-full bg-white/70 text-slate-800 hover:bg-white transition shadow">Goals & Progress</button>
        </nav>
      </div>
    </header>

    <!-- Page 1: Budget Tracker -->
    <main id="page-budget" class="page active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Income & Summary -->
        <div class="lg:col-span-1 space-y-6">
          <div class="glass soft-shadow rounded-2xl p-6">
            <h2 class="card-title text-xl font-semibold mb-4 text-slate-700">Monthly Income</h2>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500">$</span>
              <input type="number" id="income" class="w-full pl-7 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-white/80" placeholder="Enter total monthly income" value="4200" />
            </div>
          </div>
          <div id="summary-card" class="glass soft-shadow rounded-2xl p-6">
            <h2 class="card-title text-xl font-semibold mb-4 text-slate-700">Summary</h2>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Income</span>
                <span id="summary-income" class="font-bold text-emerald-700">$0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Expenses</span>
                <span id="summary-expenses" class="font-bold text-rose-600">$0.00</span>
              </div>
              <hr class="my-2 border-slate-200/70" />
              <div class="flex justify-between items-center text-lg">
                <span class="font-semibold text-slate-700">Remaining</span>
                <span id="summary-remaining" class="font-extrabold text-indigo-700">$0.00</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Expenses -->
        <div class="lg:col-span-2 glass soft-shadow rounded-2xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-xl font-semibold text-slate-700">Expenses</h2>
            <button id="add-expense" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-2 rounded-xl shadow hover:brightness-110 transition text-sm font-medium">Add Expense</button>
          </div>
          <div id="expenses-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
      </div>
    </main>

    <!-- Page 2: Financial Goals -->
    <main id="page-goals" class="page">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Goal Management -->
        <div class="lg:col-span-1 space-y-6">
          <div class="glass soft-shadow rounded-2xl p-6">
            <h2 class="card-title text-xl font-semibold mb-4 text-slate-700">Set Your Goals</h2>
            <div class="space-y-4">
              <div>
                <label for="goal-name" class="block text-sm font-medium text-slate-700">Goal Name</label>
                <input type="text" id="goal-name" class="mt-1 w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white/80" placeholder="e.g., Vacation Fund" />
              </div>
              <div>
                <label for="goal-amount" class="block text-sm font-medium text-slate-700">Target Amount</label>
                <input type="number" id="goal-amount" class="mt-1 w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white/80" placeholder="e.g., 5000" />
              </div>
              <button id="add-goal" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-2 rounded-xl shadow hover:brightness-110 transition font-semibold">Add Goal</button>
            </div>
          </div>
          <div id="goals-list" class="glass soft-shadow rounded-2xl p-6 space-y-4">
            <h2 class="card-title text-xl font-semibold text-slate-700">Your Goals</h2>
          </div>
        </div>

        <!-- Charts -->
        <div class="lg:col-span-2 space-y-6">
          <div class="glass soft-shadow rounded-2xl p-6">
            <h2 class="card-title text-xl font-semibold mb-4 text-slate-700">Expense Breakdown</h2>
            <div class="chart-container">
              <canvas id="expense-chart"></canvas>
            </div>
          </div>
          <div class="glass soft-shadow rounded-2xl p-6">
            <h2 class="card-title text-xl font-semibold mb-4 text-slate-700">Goal Progress</h2>
            <div class="stacked-chart">
              <canvas id="goal-chart-lines"></canvas>
              <canvas id="goal-chart-bars"></canvas>
            </div>
            <p class="mt-2 text-xs text-slate-500">Lines show cumulative deposits over time. Bars show current saved vs remaining for each goal.</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---------------- State ----------------
      let state = {
        meta: { createdAt: Date.now() },
        income: 4200,
        expenses: [
          { id: Date.now() + 1, name: 'Rent/Mortgage', amount: 1450 },
          { id: Date.now() + 2, name: 'Groceries', amount: 450 },
          { id: Date.now() + 3, name: 'Utilities (Electric, Gas, Water)', amount: 200 },
          { id: Date.now() + 4, name: 'Gasoline', amount: 150 },
          { id: Date.now() + 5, name: 'Car Insurance', amount: 120 },
          { id: Date.now() + 6, name: 'Internet', amount: 70 },
          { id: Date.now() + 7, name: 'Phone Bill', amount: 80 },
          { id: Date.now() + 8, name: 'Subscriptions', amount: 40 },
          { id: Date.now() + 9, name: 'Dining Out', amount: 200 },
        ],
        goals: [
          { id: Date.now() + 10, name: 'Emergency Fund', target: 5000, saved: 1200 },
          { id: Date.now() + 11, name: 'New Car', target: 25000, saved: 4500 },
        ],
        // goalHistory maps goalId -> array of { t: timestamp(ms), y: cumulativeSaved }
        goalHistory: {}
      };

      // ---------------- DOM ----------------
      const incomeInput = document.getElementById('income');
      const expensesList = document.getElementById('expenses-list');
      const addExpenseBtn = document.getElementById('add-expense');
      const summaryIncome = document.getElementById('summary-income');
      const summaryExpenses = document.getElementById('summary-expenses');
      const summaryRemaining = document.getElementById('summary-remaining');

      const goalNameInput = document.getElementById('goal-name');
      const goalAmountInput = document.getElementById('goal-amount');
      const addGoalBtn = document.getElementById('add-goal');
      const goalsList = document.getElementById('goals-list');

      const navBudgetBtn = document.getElementById('nav-budget');
      const navGoalsBtn = document.getElementById('nav-goals');
      const pages = document.querySelectorAll('.page');

      // ---------------- Charts ----------------
      let expenseChart = null;
      let goalBarsChart = null;
      let goalLinesChart = null;

      // Chart.js plugin for subtle shadow glow
      const glowPlugin = {
        id: 'datasetGlow',
        afterDatasetsDraw(chart, args, pluginOptions) {
          const { ctx } = chart;
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            if (!meta.hidden && meta.type !== 'doughnut') {
              ctx.save();
              ctx.shadowColor = 'rgba(2, 6, 23, 0.15)';
              ctx.shadowBlur = 12;
              ctx.shadowOffsetY = 6;
              meta.dataset && meta.dataset.draw(ctx);
              ctx.restore();
            }
          });
        }
      };

      // Gradient helpers
      const makeLinearGradient = (ctx, area, from, to) => {
        const gradient = ctx.createLinearGradient(0, area.bottom, 0, area.top);
        gradient.addColorStop(0, from);
        gradient.addColorStop(1, to);
        return gradient;
      };

      // ---------------- Persistence ----------------
      const saveState = () => localStorage.setItem('budgetTrackerState_v2', JSON.stringify(state));
      const loadState = () => {
        const saved = localStorage.getItem('budgetTrackerState_v2');
        if (saved) {
          state = JSON.parse(saved);
        }
      };

      // Ensure goalHistory exists and is aligned with goals
      const ensureGoalHistory = () => {
        if (!state.goalHistory) state.goalHistory = {};
        // Add missing histories
        state.goals.forEach(g => {
          if (!state.goalHistory[g.id]) {
            state.goalHistory[g.id] = [ { t: state.meta?.createdAt || Date.now(), y: g.saved || 0 } ];
          } else if (!Array.isArray(state.goalHistory[g.id]) || state.goalHistory[g.id].length === 0) {
            state.goalHistory[g.id] = [ { t: state.meta?.createdAt || Date.now(), y: g.saved || 0 } ];
          }
        });
        // Drop histories for removed goals
        Object.keys(state.goalHistory).forEach(id => {
          if (!state.goals.find(g => String(g.id) === String(id))) delete state.goalHistory[id];
        });
      };

      // ---------------- Calculations ----------------
      const calculateSummary = () => {
        const totalExpenses = state.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
        const remaining = (parseFloat(state.income) || 0) - totalExpenses;
        summaryIncome.textContent = formatCurrency(state.income || 0);
        summaryExpenses.textContent = formatCurrency(totalExpenses);
        summaryRemaining.textContent = formatCurrency(remaining);
        if (remaining < 0) {
          summaryRemaining.classList.remove('text-blue-700', 'text-green-600');
          summaryRemaining.classList.add('text-red-700');
        } else {
          summaryRemaining.classList.remove('text-red-700');
          summaryRemaining.classList.add('text-blue-700');
        }
        return { totalExpenses, remaining };
      };

      // ---------------- Rendering ----------------
      const renderExpenses = () => {
        expensesList.innerHTML = '';
        if (state.expenses.length === 0) {
          expensesList.innerHTML = `<p class="text-center text-gray-500">No expenses added yet. Add one to get started.</p>`;
        }
        state.expenses.forEach(expense => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 p-2 rounded-xl hover:bg-white/70 transition';
          div.innerHTML = `
            <input type="text" value="${escapeHtml(expense.name || '')}" data-id="${expense.id}" class="expense-name flex-grow p-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-400 bg-white/80" placeholder="Expense Name" />
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
              <input type="number" value="${Number(expense.amount || 0)}" data-id="${expense.id}" class="expense-amount w-32 pl-7 pr-2 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-400 bg-white/80" placeholder="Amount" />
            </div>
            <button data-id="${expense.id}" class="remove-expense bg-rose-100 text-rose-600 hover:bg-rose-200 p-2 rounded-full transition-colors shadow" title="Remove">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
          `;
          expensesList.appendChild(div);
        });
      };

      const renderGoals = () => {
        goalsList.innerHTML = `<h2 class="text-xl font-semibold text-gray-600 mb-2">Your Goals</h2>`;
        if (state.goals.length === 0) {
          goalsList.innerHTML += `<p class="text-center text-gray-500">No goals added yet.</p>`;
        }
        state.goals.forEach(goal => {
          const pct = goal.target > 0 ? Math.min(100, (goal.saved / goal.target) * 100) : 0;
          const div = document.createElement('div');
          div.className = 'goal-item space-y-2 p-3 rounded-xl bg-white/70 border border-white/60';
          div.innerHTML = `
            <div class="flex justify-between items-baseline">
              <span class="font-semibold text-gray-700">${escapeHtml(goal.name)}</span>
              <button data-id="${goal.id}" class="remove-goal text-red-400 hover:text-red-600 text-xs">Remove</button>
            </div>
            <div class="flex justify-between items-center text-sm text-gray-500">
              <span>${formatCurrency(goal.saved || 0)}</span>
              <span>${formatCurrency(goal.target || 0)}</span>
            </div>
            <div class="w-full bg-slate-200/70 rounded-full h-2.5">
              <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-2.5 rounded-full" style="width: ${pct}%"></div>
            </div>
            <div class="flex items-center space-x-2 mt-2">
              <input type="number" data-id="${goal.id}" class="goal-contribution w-full p-1 border border-gray-200 rounded-lg text-sm" placeholder="Contribute amount" />
              <button data-id="${goal.id}" class="contribute-goal bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 text-sm rounded-lg">Add</button>
            </div>
          `;
          goalsList.appendChild(div);
        });
      };

      const renderCharts = () => {
        renderExpenseChart();
        renderGoalCharts();
      };

      const renderExpenseChart = () => {
        const canvas = document.getElementById('expense-chart');
        const ctx = canvas.getContext('2d');
        const labels = state.expenses.map(e => e.name || 'Untitled');
        const data = state.expenses.map(e => Number(e.amount || 0));
        if (expenseChart) expenseChart.destroy();
        const colors = generateColors(data.length);
        expenseChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              label: 'Expenses',
              data,
              backgroundColor: colors.map(c => c),
              borderColor: '#fff',
              borderWidth: 2,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '62%',
            layout: { padding: 8 },
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 14, color: '#334155', font: { weight: 500 } } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
            },
            animation: { animateRotate: true, animateScale: true }
          }
        });
      };

      const renderGoalCharts = () => {
        // Bars: saved vs remaining per goal (categorical)
        const barsCanvas = document.getElementById('goal-chart-bars');
        const barsCtx = barsCanvas.getContext('2d');
        const labels = state.goals.map(g => g.name);
        const savedData = state.goals.map(g => g.saved || 0);
        const remainingData = state.goals.map(g => Math.max(0, (g.target || 0) - (g.saved || 0)));
        if (goalBarsChart) goalBarsChart.destroy();

        // Build gradients using chart area after layout
        const buildBarConfig = () => ({
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'Amount Saved',
                data: savedData,
                backgroundColor: (ctx) => {
                  const { chart } = ctx; const { ctx: c, chartArea } = chart;
                  if (!chartArea) return 'rgba(16,185,129,0.6)';
                  return makeLinearGradient(c, chartArea, 'rgba(16,185,129,0.35)', 'rgba(16,185,129,0.85)');
                },
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1,
                borderRadius: 10,
                barThickness: 'flex'
              },
              {
                label: 'Amount Remaining',
                data: remainingData,
                backgroundColor: (ctx) => {
                  const { chart } = ctx; const { ctx: c, chartArea } = chart;
                  if (!chartArea) return 'rgba(99,102,241,0.2)';
                  return makeLinearGradient(c, chartArea, 'rgba(99,102,241,0.15)', 'rgba(99,102,241,0.35)');
                },
                borderColor: 'rgba(99,102,241,1)',
                borderWidth: 1,
                borderRadius: 10,
                barThickness: 'flex'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 8, right: 8, left: 8, bottom: 0 } },
            scales: {
              x: { stacked: true, grid: { display: false } },
              y: { stacked: true, beginAtZero: true, ticks: { callback: v => '$' + v }, grid: { color: 'rgba(51,65,85,0.08)' } }
            },
            plugins: { legend: { position: 'top' } },
            animation: { duration: 700, easing: 'easeOutQuart' }
          },
          plugins: [glowPlugin]
        });

        goalBarsChart = new Chart(barsCtx, buildBarConfig());

        // Lines: cumulative deposits over time per goal (time axis)
        const linesCanvas = document.getElementById('goal-chart-lines');
        const linesCtx = linesCanvas.getContext('2d');
        const colorPool = generateColors(state.goals.length);
        const datasets = state.goals.map((g, idx) => ({
          type: 'line',
          label: g.name + ' deposits',
          data: (state.goalHistory[g.id] || []).map(p => ({ x: p.t, y: p.y })),
          borderColor: colorPool[idx % colorPool.length],
          backgroundColor: 'transparent',
          borderWidth: 3,
          tension: 0.3,
          pointRadius: 0
        }));
        if (goalLinesChart) goalLinesChart.destroy();
        goalLinesChart = new Chart(linesCtx, {
          data: { datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            parsing: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { display: false } },
            animations: { tension: { duration: 800, easing: 'easeInOutCubic', from: 0.4, to: 0.2, loop: false } },
            scales: {
              x: { type: 'time', time: { unit: 'week' }, grid: { color: 'rgba(51,65,85,0.06)' } },
              y: { beginAtZero: true, grid: { color: 'rgba(51,65,85,0.06)' } }
            }
          },
          plugins: [glowPlugin]
        });
      };

      // ---------------- Events ----------------
      const handleIncomeChange = e => {
        state.income = parseFloat(e.target.value) || 0;
        calculateSummary();
        // Live sync the pie chart if on Goals page
        if (isGoalsActive()) renderExpenseChart();
        saveState();
      };

      const handleAddExpense = () => {
        state.expenses.push({ id: Date.now(), name: '', amount: 0 });
        updateApp();
      };

      const handleExpenseListChanges = e => {
        const id = parseInt(e.target.dataset.id);
        if (e.target.classList.contains('remove-expense') || e.target.closest('.remove-expense')) {
          const btn = e.target.closest('.remove-expense');
          const rmId = parseInt(btn.dataset.id);
          state.expenses = state.expenses.filter(ex => ex.id !== rmId);
          updateApp();
          return;
        }
        if (e.target.classList.contains('expense-name')) {
          const ex = state.expenses.find(x => x.id === id);
          if (ex) ex.name = e.target.value;
        }
        if (e.target.classList.contains('expense-amount')) {
          const ex = state.expenses.find(x => x.id === id);
          if (ex) ex.amount = parseFloat(e.target.value) || 0;
        }
        calculateSummary();
        if (isGoalsActive()) renderExpenseChart();
        saveState();
      };

      const handleAddGoal = () => {
        const name = goalNameInput.value.trim();
        const target = parseFloat(goalAmountInput.value);
        if (!name || !(target > 0)) { alert('Enter a valid goal name and target.'); return; }
        const id = Date.now();
        state.goals.push({ id, name, target, saved: 0 });
        // Initialize history with zero at now
        state.goalHistory[id] = [ { t: Date.now(), y: 0 } ];
        goalNameInput.value = '';
        goalAmountInput.value = '';
        updateApp();
      };

      const handleGoalListChanges = e => {
        const id = parseInt(e.target.dataset.id);
        if (e.target.classList.contains('remove-goal')) {
          state.goals = state.goals.filter(g => g.id !== id);
          delete state.goalHistory[id];
          updateApp();
          return;
        }
        if (e.target.classList.contains('contribute-goal')) {
          const input = e.target.previousElementSibling;
          const amount = parseFloat(input.value);
          if (!isNaN(amount) && amount > 0) {
            const goal = state.goals.find(g => g.id === id);
            if (goal) {
              goal.saved += amount;
              recordGoalDeposit(id, amount);
            }
            input.value = '';
            updateApp();
          }
        }
      };

      const switchPage = pageId => {
        pages.forEach(page => {
          page.classList.toggle('active', page.id === pageId);
        });
        const activateButton = btn => {
          btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white');
          btn.classList.remove('bg-white/70', 'text-slate-800');
        };
        const deactivateButton = btn => {
          btn.classList.add('bg-white/70', 'text-slate-800');
          btn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white');
        };

        if (pageId === 'page-budget') {
          activateButton(navBudgetBtn);
          deactivateButton(navGoalsBtn);
        } else {
          activateButton(navGoalsBtn);
          deactivateButton(navBudgetBtn);
          // Re-render charts whenever entering Goals page for fresh sync
          renderCharts();
        }
      };

      // ---------------- Utils ----------------
      const isGoalsActive = () => document.getElementById('page-goals').classList.contains('active');
      const formatCurrency = amt => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amt || 0);
      const generateColors = num => {
        const base = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#14B8A6','#F97316','#D946EF','#22C55E','#0EA5E9'];
        const out = []; for (let i = 0; i < num; i++) out.push(base[i % base.length]); return out;
      };
      const escapeHtml = s => String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

      const recordGoalDeposit = (goalId, amount) => {
        ensureGoalHistory();
        const hist = state.goalHistory[goalId] || [];
        const prev = hist.length ? hist[hist.length - 1].y : 0;
        hist.push({ t: Date.now(), y: prev + amount });
        state.goalHistory[goalId] = hist;
      };

      // ---------------- App Orchestration ----------------
      const updateApp = () => {
        ensureGoalHistory();
        calculateSummary();
        renderExpenses();
        renderGoals();
        if (isGoalsActive()) renderCharts();
        saveState();
      };

      const init = () => {
        loadState();
        ensureGoalHistory();
        incomeInput.value = state.income;
        calculateSummary();
        renderExpenses();
        renderGoals();

        // Events
        incomeInput.addEventListener('input', handleIncomeChange);
        addExpenseBtn.addEventListener('click', handleAddExpense);
        expensesList.addEventListener('input', handleExpenseListChanges);
        expensesList.addEventListener('click', handleExpenseListChanges);
        addGoalBtn.addEventListener('click', handleAddGoal);
        goalsList.addEventListener('click', handleGoalListChanges);
        navBudgetBtn.addEventListener('click', () => switchPage('page-budget'));
        navGoalsBtn.addEventListener('click', () => switchPage('page-goals'));
      };

      init();
    });
  </script>
</body>
</html>
